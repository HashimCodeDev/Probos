// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Sensor {
  id          String   @id @default(cuid())
  sensorId    String   @unique
  zone        String
  type        String
  latitude    Float?
  longitude   Float?
  installedAt DateTime @default(now())

  readings    Reading[]
  trustScores TrustScore[]
  tickets     Ticket[]

  @@index([zone])
}

model Reading {
  id          String   @id @default(cuid())
  sensorId    String
  timestamp   DateTime @default(now())

  // Core sensor parameters
  moisture    Float?
  temperature Float?
  ec          Float?
  ph          Float?   // ← NEW: was missing from original schema

  // Environmental context (used by physical plausibility check)
  airTemp          Float?   // air temperature at time of reading
  isRaining        Boolean  @default(false)
  irrigationActive Boolean  @default(false)

  sensor      Sensor   @relation(fields: [sensorId], references: [id])

  @@index([sensorId, timestamp])
  @@index([timestamp(sort: Desc)])  // For recent readings across all sensors
}

model TrustScore {
  id            String   @id @default(cuid())
  sensorId      String
  lastEvaluated DateTime @default(now())

  // ── Core score (0.0 – 1.0) ──
  score         Float    @default(1.0)
  status        String   @default("Healthy")   // Healthy | Warning | Anomalous
  label         String   @default("Reliable")  // Highly Reliable | Reliable | Uncertain | Unreliable | Anomaly

  // ── Per-parameter trust scores (0.0 – 1.0) ──
  paramMoisture     Float?
  paramTemperature  Float?
  paramEc           Float?
  paramPh           Float?

  // ── Fault flags ──
  lowVariance   Boolean  @default(false)   // static/frozen sensor
  spikeDetected Boolean  @default(false)   // sudden spike
  zoneAnomaly   Boolean  @default(false)   // isolated zone deviation

  // ── Diagnostic engine outputs ──
  rootCauses    String[] @default([])      // SPIKE | STATIC | DRIFT | ZONE_MISMATCH | etc.
  severity      String   @default("None")  // Critical | High | Medium | Low | None
  diagnostic    String?                    // human-readable diagnosis message
  flags         String[] @default([])      // detailed flag messages

  // ── Health trend tracking ──
  healthTrend   String   @default("stable")   // improving | stable | degrading
  healthSlope   Float    @default(0)           // regression slope of recent scores
  anomalyRate   Float    @default(0)           // fraction of recent scores that were anomalous

  sensor        Sensor   @relation(fields: [sensorId], references: [id])

  @@index([sensorId])
  @@index([lastEvaluated])
  @@index([status])
  @@index([sensorId, lastEvaluated(sort: Desc)])  // Composite for latest trust score queries
  @@index([status, severity])                      // Composite for dashboard aggregations
  @@index([severity, lastEvaluated(sort: Desc)])  // For severity-based sorting
}

model Ticket {
  id         String    @id @default(cuid())
  sensorId   String
  issue      String
  severity   String
  status     String    @default("Open")   // Open | InProgress | Resolved
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  sensor     Sensor    @relation(fields: [sensorId], references: [id])

  @@index([status])
  @@index([sensorId])
  @@index([severity])
  @@index([status, createdAt(sort: Desc)])  // For status-filtered ticket lists
  @@index([sensorId, status])               // For sensor-specific tickets by status
  @@index([severity, createdAt(sort: Desc)]) // For severity-based prioritization
}
